<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Secure WiFi access with ConnectSphere">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Connectspeherestyle.css">
    <title>ConnectSphere: WiFi Portal</title>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="connectsphere-portal">
    <div class="connectsphere-container" id="csPortal">
        <div class="cs-header">
            <div class="cs-logo">
                <div class="cs-logo-icon">
                    <i class="fas fa-wifi"></i>
                </div>
                <div class="cs-logo-text">ConnectSphere</div>
                <div class="cs-tagline">Secure WiFi Access</div>
            </div>
        </div>
        
        <div class="cs-form-container">
            <h2 class="cs-form-title">Connect to WiFi</h2>
            
            <div id="csStatus" class="cs-status" style="display: none;"></div>
            
            <form id="csConnectForm">
                <div class="cs-form-group">
                    <label class="cs-label">Full Name</label>
                    <input type="text" class="cs-input" id="csName" placeholder="Enter your name" required>
                </div>
                
                <div class="cs-form-group">
                    <label class="cs-label">Email Address</label>
                    <input type="email" class="cs-input" id="csEmail" placeholder="your@email.com" required>
                </div>
                
                <div class="cs-form-group">
                    <label class="cs-label">Phone Number</label>
                    <input type="tel" class="cs-input" id="csPhone" placeholder="+254 700 000 000">
                </div>
                
                <div class="cs-form-group">
                    <label class="cs-label">Access Duration</label>
                    <select class="cs-input" id="csDuration">
                        <option value="1">1 Hour - Free</option>
                        <option value="4" selected>4 Hours - Standard</option>
                        <option value="8">8 Hours - Extended</option>
                        <option value="24">24 Hours - Premium</option>
                    </select>
                </div>
                
                <div class="cs-form-group">
                    <label class="cs-label" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="csTerms" required>
                        <span>I agree to the <a href="#" onclick="showTerms()">Terms & Conditions</a></span>
                    </label>
                </div>
                
                <button type="submit" class="cs-btn" id="csConnectBtn">
                    <i class="fas fa-plug"></i>
                    Connect to Network
                </button>
                
                <div style="text-align: center; margin: 20px 0; color: var(--cs-gray);">
                    ─── or connect with ───
                </div>
                
                <div class="cs-social-login">
                    <button type="button" class="cs-social-btn" onclick="connectSphere.socialLogin('google')">
                        <i class="fab fa-google" style="color: #DB4437;"></i>
                    </button>
                    <button type="button" class="cs-social-btn" onclick="connectSphere.socialLogin('facebook')">
                        <i class="fab fa-facebook-f" style="color: #4267B2;"></i>
                    </button>
                    <button type="button" class="cs-social-btn" onclick="connectSphere.showVoucherForm()">
                        <i class="fas fa-ticket-alt" style="color: var(--cs-primary);"></i>
                    </button>
                </div>
                
                <button type="button" class="cs-btn cs-btn-secondary" onclick="connectSphere.showVoucherForm()" style="margin-top: 20px;">
                    <i class="fas fa-ticket-alt"></i>
                    I have a voucher code
                </button>
                
                <div class="cs-terms">
                    By connecting, you agree to our <a href="#" onclick="showTerms()">Terms of Service</a> 
                    and <a href="#" onclick="showPrivacy()">Privacy Policy</a>.
                </div>
            </form>
            
            <div class="cs-connection-animation" id="csConnecting">
                <div style="margin-bottom: 30px;">
                    <div class="cs-wave"></div>
                    <div class="cs-wave"></div>
                    <div class="cs-wave"></div>
                    <div class="cs-wave"></div>
                    <div class="cs-wave"></div>
                </div>
                <h3 style="margin-bottom: 10px; color: var(--cs-primary);">Connecting...</h3>
                <p style="color: var(--cs-gray); font-size: 14px;">Please wait while we establish your secure connection</p>
            </div>
        </div>
        
        <div class="cs-footer">
            <p>Powered by <a href="#" onclick="showAbout()">ConnectSphere WiFi Platform</a></p>
            <p style="font-size: 11px; margin-top: 5px; opacity: 0.7;">
                © 2024 ConnectSphere. All rights reserved.
            </p>
        </div>
    </div>

    <script>
        // ===================== SUPABASE CONFIGURATION =====================
        // REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://uadbyyaxlieemfaofode.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZGJ5eWF4bGllZW1mYW9mb2RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDMyODUsImV4cCI6MjA4MTM3OTI4NX0.Gh3J0GpdQ8yXU-976JNjJKuY6rkBvn3Vkllq2vz37No';
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===================== CONNECTSPHERE PORTAL =====================
        const connectSphere = {
            config: {
                portalId: 'MAIN_PORTAL',
                sessionDuration: 4, // hours
                redirectUrl: 'https://welcome.connectsphere.io',
                voucherDuration: 24
            },
            
            // Initialize portal
            init() {
                console.log('ConnectSphere Portal initialized');
                this.bindEvents();
                this.checkExistingSession();
            },
            
            // Bind form events
            bindEvents() {
                const form = document.getElementById('csConnectForm');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.processConnection();
                });
            },
            
            // Main connection process
            async processConnection() {
                // Get user data
                const userData = {
                    name: document.getElementById('csName').value.trim(),
                    email: document.getElementById('csEmail').value.trim(),
                    phone: document.getElementById('csPhone').value.trim(),
                    duration: parseInt(document.getElementById('csDuration').value),
                    mac_address: await this.getDeviceId(),
                    ip_address: await this.getClientIP(),
                    device_info: this.getDeviceInfo(),
                    terms_accepted: document.getElementById('csTerms').checked
                };
                
                // Validate form
                if (!this.validateForm(userData)) {
                    return;
                }
                
                // Show loading
                this.showLoading(true);
                
                try {
                    // 1. Save user to Supabase
                    const sessionId = await this.saveUserToSupabase(userData);
                    
                    // 2. Create WiFi session
                    await this.createWiFiSession(userData, sessionId);
                    
                    // 3. Log analytics
                    await this.logAnalytics('user_connected', userData, sessionId);
                    
                    // 4. Show success and redirect
                    this.showSuccess('Connected successfully! Redirecting...');
                    
                    setTimeout(() => {
                        window.location.href = this.config.redirectUrl;
                    }, 2000);
                    
                } catch (error) {
                    console.error('Connection error:', error);
                    this.showError('Connection failed: ' + error.message);
                    this.showLoading(false);
                }
            },
            
            // ===================== SUPABASE OPERATIONS =====================
            
            // Save user to Supabase
            async saveUserToSupabase(userData) {
                try {
                    // Check if user exists
                    const { data: existingUser } = await supabaseClient
                        .from('wifi_users')
                        .select('id')
                        .eq('email', userData.email)
                        .maybeSingle();
                    
                    if (existingUser) {
                        // Update existing user
                        await supabaseClient
                            .from('wifi_users')
                            .update({
                                name: userData.name,
                                phone: userData.phone,
                                last_login: new Date().toISOString(),
                                mac_address: userData.mac_address,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingUser.id);
                        
                        return existingUser.id;
                    } else {
                        // Create new user
                        const { data, error } = await supabaseClient
                            .from('wifi_users')
                            .insert([{
                                name: userData.name,
                                email: userData.email,
                                phone: userData.phone,
                                mac_address: userData.mac_address,
                                ip_address: userData.ip_address,
                                created_at: new Date().toISOString(),
                                last_login: new Date().toISOString()
                            }])
                            .select();
                        
                        if (error) throw error;
                        return data[0].id;
                    }
                } catch (error) {
                    console.error('Supabase save error:', error);
                    throw error;
                }
            },
            
            // Create WiFi session in Supabase
            async createWiFiSession(userData, userId) {
                const sessionEnd = new Date();
                sessionEnd.setHours(sessionEnd.getHours() + userData.duration);
                
                const { data, error } = await supabaseClient
                    .from('wifi_sessions')
                    .insert([{
                        user_id: userId,
                        mac_address: userData.mac_address,
                        ip_address: userData.ip_address,
                        start_time: new Date().toISOString(),
                        end_time: sessionEnd.toISOString(),
                        duration_hours: userData.duration,
                        status: 'active',
                        device_info: userData.device_info
                    }])
                    .select();
                
                if (error) throw error;
                return data[0];
            },
            
            // Log analytics to Supabase
            async logAnalytics(action, data, sessionId) {
                try {
                    await supabaseClient
                        .from('portal_analytics')
                        .insert([{
                            action: action,
                            session_id: sessionId,
                            portal_id: this.config.portalId,
                            user_agent: navigator.userAgent,
                            metadata: data,
                            created_at: new Date().toISOString()
                        }]);
                } catch (error) {
                    console.warn('Analytics logging failed:', error);
                }
            },
            
            // Check voucher validity
            async checkVoucher(voucherCode) {
                try {
                    const { data, error } = await supabaseClient
                        .from('vouchers')
                        .select('*')
                        .eq('code', voucherCode.toUpperCase())
                        .eq('status', 'active')
                        .gte('expires_at', new Date().toISOString())
                        .single();
                    
                    if (error) throw new Error('Invalid voucher code');
                    
                    // Check if voucher is used up
                    if (data.used_count >= data.max_uses) {
                        throw new Error('Voucher has been fully used');
                    }
                    
                    return data;
                } catch (error) {
                    throw new Error('Voucher validation failed: ' + error.message);
                }
            },
            
            // Redeem voucher
            async redeemVoucher(voucherCode, userData) {
                try {
                    // Check voucher
                    const voucher = await this.checkVoucher(voucherCode);
                    
                    // Update voucher usage
                    await supabaseClient
                        .from('vouchers')
                        .update({
                            used_count: voucher.used_count + 1,
                            status: voucher.used_count + 1 >= voucher.max_uses ? 'used' : 'active',
                            last_used: new Date().toISOString(),
                            last_used_by: userData.email
                        })
                        .eq('id', voucher.id);
                    
                    // Create session with voucher duration
                    userData.duration = voucher.duration_hours || this.config.voucherDuration;
                    
                    return {
                        success: true,
                        duration: userData.duration,
                        message: `Voucher accepted! ${userData.duration} hours access granted.`
                    };
                } catch (error) {
                    throw error;
                }
            },
            
            // ===================== UTILITY FUNCTIONS =====================
            
            // Get unique device ID
            async getDeviceId() {
                // Generate a consistent device ID
                let deviceId = localStorage.getItem('cs_device_id');
                if (!deviceId) {
                    deviceId = 'DEV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('cs_device_id', deviceId);
                }
                return deviceId;
            },
            
            // Get client IP (simulated)
            async getClientIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch {
                    return 'unknown';
                }
            },
            
            // Get device information
            getDeviceInfo() {
                return {
                    user_agent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screen_width: screen.width,
                    screen_height: screen.height,
                    vendor: navigator.vendor,
                    cookies_enabled: navigator.cookieEnabled
                };
            },
            
            // Validate form data
            validateForm(data) {
                if (!data.name || data.name.length < 2) {
                    this.showError('Please enter your full name');
                    return false;
                }
                
                if (!this.isValidEmail(data.email)) {
                    this.showError('Please enter a valid email address');
                    return false;
                }
                
                if (data.phone && !this.isValidPhone(data.phone)) {
                    this.showError('Please enter a valid phone number');
                    return false;
                }
                
                if (!data.terms_accepted) {
                    this.showError('You must accept the terms & conditions');
                    return false;
                }
                
                return true;
            },
            
            isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            },
            
            isValidPhone(phone) {
                const cleaned = phone.replace(/[\s\-\+\(\)]/g, '');
                return /^(254|0)[17]\d{8}$/.test(cleaned);
            },
            
            // ===================== UI FUNCTIONS =====================
            
            showLoading(show) {
                const form = document.getElementById('csConnectForm');
                const connecting = document.getElementById('csConnecting');
                
                if (show) {
                    form.style.display = 'none';
                    connecting.style.display = 'block';
                } else {
                    form.style.display = 'block';
                    connecting.style.display = 'none';
                }
            },
            
            showSuccess(message) {
                const statusDiv = document.getElementById('csStatus');
                statusDiv.className = 'cs-status cs-status-success';
                statusDiv.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
                statusDiv.style.display = 'flex';
            },
            
            showError(message) {
                const statusDiv = document.getElementById('csStatus');
                statusDiv.className = 'cs-status cs-status-error';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
                statusDiv.style.display = 'flex';
            },
            
            // ===================== SOCIAL LOGIN =====================
            
            async socialLogin(provider) {
                this.showLoading(true);
                
                try {
                    let authData;
                    
                    if (provider === 'google') {
                        authData = await supabaseClient.auth.signInWithOAuth({
                            provider: 'google',
                            options: {
                                redirectTo: `${window.location.origin}/auth/callback`
                            }
                        });
                    } else if (provider === 'facebook') {
                        authData = await supabaseClient.auth.signInWithOAuth({
                            provider: 'facebook',
                            options: {
                                redirectTo: `${window.location.origin}/auth/callback`
                            }
                        });
                    }
                    
                    if (authData.error) throw authData.error;
                    
                } catch (error) {
                    this.showError('Social login failed');
                    this.showLoading(false);
                }
            },
            
            // ===================== VOUCHER SYSTEM =====================
            
            showVoucherForm() {
                const form = document.getElementById('csConnectForm');
                form.innerHTML = `
                    <h2 class="cs-form-title">Enter Voucher Code</h2>
                    <div id="csStatus" class="cs-status" style="display: none;"></div>
                    <div class="cs-form-group">
                        <label class="cs-label">Voucher Code</label>
                        <input type="text" class="cs-input" id="csVoucher" placeholder="Enter voucher code (e.g., WIFI24HRS)">
                    </div>
                    <button type="button" class="cs-btn" onclick="connectSphere.redeemVoucherProcess()">
                        <i class="fas fa-gift"></i>
                        Redeem Voucher
                    </button>
                    <button type="button" class="cs-btn cs-btn-secondary" onclick="location.reload()" style="margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i>
                        Back to Login
                    </button>
                `;
            },
            
            async redeemVoucherProcess() {
                const voucherCode = document.getElementById('csVoucher').value.trim();
                
                if (!voucherCode) {
                    this.showError('Please enter a voucher code');
                    return;
                }
                
                this.showLoading(true);
                
                try {
                    const userData = {
                        email: 'voucher@user.com',
                        name: 'Voucher User',
                        mac_address: await this.getDeviceId(),
                        ip_address: await this.getClientIP()
                    };
                    
                    const result = await this.redeemVoucher(voucherCode, userData);
                    
                    this.showSuccess(result.message);
                    
                    // Auto-redirect after voucher
                    setTimeout(() => {
                        window.location.href = this.config.redirectUrl;
                    }, 2000);
                    
                } catch (error) {
                    this.showError(error.message);
                    this.showLoading(false);
                }
            },
            
            // ===================== SESSION MANAGEMENT =====================
            
            checkExistingSession() {
                const sessionData = localStorage.getItem('cs_session');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (new Date(session.expires) > new Date()) {
                        // Session still valid, auto-redirect
                        window.location.href = this.config.redirectUrl;
                    }
                }
            },
            
            saveSession(userId, durationHours) {
                const expires = new Date();
                expires.setHours(expires.getHours() + durationHours);
                
                const sessionData = {
                    userId: userId,
                    expires: expires.toISOString(),
                    created: new Date().toISOString()
                };
                
                localStorage.setItem('cs_session', JSON.stringify(sessionData));
            }
        };
        
        // ===================== INITIALIZATION =====================
        document.addEventListener('DOMContentLoaded', () => {
            connectSphere.init();
        });
        
        // Helper functions
        function showTerms() {
            alert('Terms & Conditions:\n\n1. Fair usage policy applies\n2. No illegal activities\n3. Respect other users');
        }
        
        function showPrivacy() {
            alert('Privacy Policy:\n\nWe collect minimal data for network management and security purposes only.');
        }
        
        function showAbout() {
            alert('ConnectSphere WiFi Platform\nSecure enterprise WiFi management');
        }
    </script>
</body>
</html>
